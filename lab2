#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include <Adafruit_NeoPixel.h>

// Provide the token generation process info.
#include "addons/TokenHelper.h"
// Provide the real-time database payload printing info.
#include "addons/RTDBHelper.h"

// --- Insert your network credentials ---
#define WIFI_SSID "Bubuchacha"
#define WIFI_PASSWORD "umbalaxibua"

// --- Insert Firebase project API Key ---
#define API_KEY "AIzaSyC58kY22AMwBzdzzOfp66BRBzOZG9Kl8xo"

// --- Insert real-time database URL ---
#define DATABASE_URL "https://esp-project-5cd9d-default-rtdb.asia-southeast1.firebasedatabase.app/"

// --- NeoPixel (WS2812B) Definitions ---
#define PIN_WS2812B 16 // The ESP32 pin connected to WS2812B
#define NUM_PIXELS 8  // The number of LEDs on your strip

// Initialize the NeoPixel strip
Adafruit_NeoPixel WS2812B(NUM_PIXELS, PIN_WS2812B, NEO_GRB + NEO_KHZ800);

// --- Firebase Objects ---
FirebaseData fbdo; // Main object for sending data
FirebaseData stream; // Dedicated object for the data stream

FirebaseAuth auth;
FirebaseConfig config;

bool signupSuccess = false;
unsigned long sendLicensePlatePrevMillis = 0;

// Path to listen to for LED changes
String streamPath = "parkingLots/mainStreetGarage/spots/A02/led_status";
// Path to send license plates to
String licensePlatePath = "detected_plates/last_plate";


/**
 * @brief Sets all pixels on the strip to a specific color.
 * @param color A 32-bit color value (e.g., strip.Color(255, 0, 0))
 */
void setStripColor(uint32_t color) {
  for (int pixel = 0; pixel < NUM_PIXELS; pixel++) { // For each pixel 
    WS2812B.setPixelColor(pixel, color); // Set color 
  }
  WS2812B.show(); // Update the strip
}

/**
 * @brief Generates a random Vietnamese license plate string.
 * @return A String formatted like "43A-123.01"
 */
String generateLicensePlate()
{
  int province = 43; // Da Nang
  char series = random('A', 'Z' + 1); // Random letter 'A' through 'Z'
  int num1 = random(100, 1000);     // Random number 100-999
  int num2 = random(0, 100);        // Random number 0-99

  // Buffer to hold the formatted string
  char licensePlateBuffer[15];

  // Format the string: "43A-230.42"
  snprintf(licensePlateBuffer, 15, "%d%c-%03d.%02d",
           province,
           series,
           num1,
           num2);

  return String(licensePlateBuffer);
}


void setup()
{
  Serial.begin(115200);

  // Initialize NeoPixel strip
  WS2812B.begin();
  WS2812B.show(); // Initialize all pixels to 'off'
  setStripColor(WS2812B.Color(0, 0, 255)); // Set to Blue while connecting

  // Use a random analog pin for a better random seed
  randomSeed(analogRead(0));

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to Wi-Fi");
  while (WiFi.status() != WL_CONNECTED)
  {
    Serial.print(".");
    delay(200);
  }
  Serial.println("\nConnected to Wi-Fi");
  Serial.println(WiFi.localIP());

  // Assigning the project API key and database URL
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  // Check signup status
  if (Firebase.signUp(&config, &auth, "", ""))
  {
    Serial.println("Firebase sign up OK");
    signupSuccess = true;
  }
  else
  {
    Serial.printf("Firebase sign up ERROR: %s\n", config.signer.signupError.message.c_str());
  }

  // Assign the callback function for token generation task
  config.token_status_callback = tokenStatusCallback;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  // --- Start the Firebase Stream ---
  // This begins listening for any data changes at the specified path.
  if (!Firebase.RTDB.beginStream(&stream, streamPath.c_str()))
  {
    Serial.printf("Error starting stream: %s\n", stream.errorReason().c_str());
  }
  else
  {
    Serial.printf("Stream started at path: %s\n", streamPath.c_str());
  }
}

void loop()
{
  // Check if Firebase is ready and signup was successful
  if (Firebase.ready() && signupSuccess)
  {
    // --- 1. Check for new data on the stream (for LED) ---
    // This function checks if new data has arrived on the stream.
    if (Firebase.RTDB.readStream(&stream))
    {
      // Check if the stream has new data available
      if (stream.streamAvailable())
      {
        // Check if the data type is a string (as expected for "on"/"off")
        if (stream.dataType() == "string")
        {
          String status = stream.stringData();
          Serial.printf("LED Status changed: %s\n", status.c_str());

          if (status == "on")
          {
            setStripColor(WS2812B.Color(255, 0, 0)); // Red
          }
          else if (status == "off")
          {
            setStripColor(WS2812B.Color(0, 255, 0)); // Green
          }
          else
          {
            setStripColor(WS2812B.Color(0, 0, 0)); // Off for any other value
          }
        }
      }
    }

    // --- 2. Send license plate data every 3 seconds ---
    if (millis() - sendLicensePlatePrevMillis > 3000)
    {
      sendLicensePlatePrevMillis = millis();

      String licensePlate = generateLicensePlate();
      Serial.printf("Sending license plate: %s\n", licensePlate.c_str());

      // Send the string to the database
      if (!Firebase.RTDB.setString(&fbdo, licensePlatePath.c_str(), licensePlate.c_str()))
      {
        // If sending failed, print the error
        Serial.printf("Error sending plate: %s\n", fbdo.errorReason().c_str());
      }
    }
  }
}
